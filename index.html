<!-- START OF FILE 2026v2.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>2026 Celebration Stock</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- PWAç›¸å…³ -->
    <meta name="theme-color" content="#050505">
    
    <!-- å¼•å…¥å¤–éƒ¨æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- 3D åœºæ™¯ä¸“ç”¨æ ·å¼ --- */
        body {
            background-color: #050505;
            overflow-x: hidden;
        }

        #three-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: none; 
            pointer-events: auto;
        }
        
        canvas { display: block; }

        #three-ui {
            position: absolute;
            bottom: 100px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            z-index: 110;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* --- ä¿®æ”¹ï¼šåº—é“ºå¡ç‰‡æ ·å¼ --- */
        .floating-shop-card {
            position: absolute;
            top: 0;
            left: 0;
            width: 210px; 
            background: rgba(25, 25, 35, 0.85); 
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 215, 0, 0.5);
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            pointer-events: auto;
            transform-origin: center center;
            display: none;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.25);
            opacity: 0; /* åˆå§‹å®Œå…¨é€æ˜ */
            transition: opacity 1.2s ease-out, transform 0.2s;
            will-change: transform, opacity;
            z-index: 105;
        }
        
        .floating-shop-card:active {
            transform: scale(0.95);
        }

        .floating-shop-card img {
            width: 100%;
            height: 135px; 
            object-fit: contain;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.05); 
            border-radius: 6px;
        }

        .floating-shop-card .shop-name {
            font-size: 21px; 
            color: #ffd700; 
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .shop-container.original-list { display: none !important; }

        .hide-3d {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s ease;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body class="dark-mode">

    <!-- SPLASH SCREEN -->
    <div id="splashScreen">
        <div class="splash-content">
            <span class="material-icons-round splash-logo-icon">auto_awesome</span>
            <h1 class="splash-title">Happy New Year</h1>
            <div class="splash-subtitle">2026</div>
            <div class="splash-loader"></div>
        </div>
    </div>

    <!-- è®¤è¯å®¹å™¨ -->
    <div id="authContainer" class="auth-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 9999;">
        <div class="auth-box" style="width: 90%; max-width: 400px;">
            <h2 id="authTitle" style="text-align: center;">Welcome Back</h2>
            <div id="loginForm" class="auth-form">
                <div style="margin-bottom: 16px;"><input type="email" id="loginEmail" placeholder="Email Address" required></div>
                <div style="margin-bottom: 20px;"><input type="password" id="loginPassword" placeholder="Password" required></div>
                <button id="loginButton">Login</button>
                <div class="switch-form" onclick="switchToRegister()" style="text-align: center;">Create an account</div>
            </div>
             <div id="registerForm" class="auth-form" style="display: none;">
                <div style="margin-bottom: 16px;"><input type="email" id="registerEmail" placeholder="Email Address" required></div>
                <div style="margin-bottom: 16px;"><input type="password" id="registerPassword" placeholder="Create Password" required></div>
                <div style="margin-bottom: 20px;"><input type="text" id="registerName" placeholder="Your Name" required></div>
                <button id="registerButton">Register</button>
                <div class="switch-form" onclick="switchToLogin()" style="text-align: center;">Already have an account? Login</div>
            </div>
            <div id="pendingForm" class="auth-form" style="display: none; text-align: center;">
                <div style="font-size: 50px; margin-bottom: 20px;">â³</div>
                <h3>Verification Pending</h3>
                <p style="color: var(--text-secondary); margin-bottom: 25px; font-size: 0.9rem;">Your account is under review.</p>
                <button onclick="backToLogin()" style="background: transparent; color: var(--text-primary); border: 1px solid var(--border-color);">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- éšè—çš„ç”¨æˆ·ä¿¡æ¯ -->
    <div id="userInfo" style="display: none;">
        <span id="userName"><span class="username-text">Guest</span></span>
        <span id="userRole">User</span>
    </div>

    <!-- === THREE.JS 3D å®¹å™¨ === -->
    <div id="three-container">
        <div id="three-ui">
            åŒå‡»å±å¹• é€‰æ‹©åº—é“º <br>
            <span style="font-size:10px; opacity:0.6;">Double Tap to Select Shop</span>
        </div>
        <div id="floating-shops-layer"></div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div id="mainAppContent" style="opacity: 0; transition: opacity 0.5s;">
        <h1 id="mainTitle" style="padding-top: 20px; display: none;">SmartProfits Stock Request</h1>
        
        <div class="shop-container original-list">
            <div class="shop-data" data-id="*JKL*" data-name="JKL" data-img="shop/jkl.png"></div>
            <div class="shop-data" data-id="*TOM*" data-name="TOM" data-img="shop/tom.png"></div>
            <div class="shop-data" data-id="*Ole-Ole Dalam*" data-name="Ole-Ole Dalam" data-img="shop/dalam.png"></div>
            <div class="shop-data" data-id="*Ole-Ole Luar*" data-name="Ole-Ole Luar" data-img="shop/luar.png"></div>
            <div class="shop-data" data-id="*Wrapping(AA)*" data-name="Wrapping(AA)" data-img="shop/Aa.png"></div>
            <div class="shop-data" data-id="*Wrapping(MAS)*" data-name="Wrapping(MAS)" data-img="shop/Mas.png"></div>
            <div class="shop-data" data-id="*Ole-Ole Tawau*" data-name="Ole-Ole Tawau" data-img="shop/tawau.png"></div>
            <div class="shop-data" data-id="*Wisma*" data-name="Wisma" data-img="shop/wisma.png"></div>
            <div class="shop-data" data-id="*Tamoi*" data-name="Tamoi" data-img="shop/Tamoi.png"></div>
            <div class="shop-data" data-id="*KTSP*" data-name="KTSP" data-img="shop/KTSP.png"></div>
        </div>

        <div id="after-shop-selection" style="display: none;">
             <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px;">
                <h3><span class="material-icons-round" style="color: var(--primary-color)">store</span> Selected: <span id="selectedShopDisplay" style="color: var(--primary-color)"></span></h3>
                <button onclick="resetToShopSelection()" style="padding: 5px 10px; font-size: 0.8rem;">Change</button>
            </div>
            <h3 id="categoryTitle"><span class="material-icons-round" style="color: var(--primary-color)">category</span> Category</h3>
            <div class="category-container" id="categoryContainer">
                <div class="category-card" onclick="selectCategory(this, 'BanHeang')"><input type="radio" name="category" value="BanHeang" id="banheang" style="display:none"><span class="category-icon">ğŸª</span><label>BanHeang</label></div>
                <div class="category-card" onclick="selectCategory(this, 'HoeHup')"><input type="radio" name="category" value="HoeHup" id="HoeHup" style="display:none"><span class="category-icon">ğŸ¥®</span><label>HoeHup</label></div>
                <div class="category-card" onclick="selectCategory(this, 'Chocolate')"><input type="radio" name="category" value="Chocolate" id="chocolate" style="display:none"><span class="category-icon">ğŸ«</span><label>Chocolate</label></div>
                <div class="category-card" onclick="selectCategory(this, 'Seafood')"><input type="radio" name="category" value="Seafood" id="seafood" style="display:none"><span class="category-icon">ğŸ¦</span><label>Seafood</label></div>
                <div class="category-card" onclick="selectCategory(this, 'Coffee')"><input type="radio" name="category" value="Coffee" id="coffee" style="display:none"><span class="category-icon">â˜•</span><label>Coffee</label></div>
                <div class="category-card" onclick="selectCategory(this, 'Amplang')"><input type="radio" name="category" value="Amplang" id="amplang" style="display:none"><span class="category-icon">ğŸŒ•</span><label>Amplang</label></div>
                <div class="category-card" onclick="selectCategory(this, 'Other')"><input type="radio" name="category" value="Other" id="other" style="display:none"><span class="category-icon">ğŸ</span><label>Other</label></div>
                <div class="category-card" onclick="selectCategory(this, 'Wrapping')"><input type="radio" name="category" value="Wrapping" id="wrapping" style="display:none"><span class="category-icon">ğŸ§¸</span><label>Wrapping</label></div>
                <div class="category-card" onclick="selectCategory(this, 'Office')"><input type="radio" name="category" value="Office" id="Office" style="display:none"><span class="category-icon">ğŸ“¦</span><label>Office</label></div>
            </div>
            <div class="tools-bar" id="searchContainer">
                <div style="position: relative; flex: 1;">
                    <span class="material-icons" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">search</span>
                    <input type="text" id="productSearch" placeholder="Search product..." oninput="searchProduct()" autocomplete="off">
                </div>
                <div class="view-toggle-group" id="viewToggleContainer">
                    <button id="listViewBtn" onclick="toggleView('list')" class="view-toggle-btn active"><span class="material-icons">view_list</span></button>
                    <button id="gridViewBtn" onclick="toggleView('grid')" class="view-toggle-btn"><span class="material-icons">grid_view</span></button>
                </div>
            </div>
            <div id="suggestions" style="background: var(--surface-color); border-radius: 12px; margin-bottom: 10px; overflow: hidden; display: none;"></div>
            <h3 id="selectItemsTitle" style="display: none;"><span class="material-icons-round" style="color: var(--primary-color)">list_alt</span> Select Items</h3>
            <div id="productList" style="display: none;"></div>
        </div>

        <div class="bottom-nav">
            <div class="bottom-nav-item" id="menuNavItem" onclick="toggleDashboard()">
                <span class="material-icons">menu</span><span>Menu</span>
            </div>
            <div class="bottom-nav-item" id="previewNavItem" onclick="togglePreview()">
                <div style="position: relative;">
                    <span class="material-icons">shopping_cart</span>
                    <span id="orderCountBadge" class="order-count-badge" style="display: none;">0</span>
                </div>
                <span>Order</span>
            </div>
            <div class="bottom-nav-item" id="settingsNavItem" onclick="toggleSettings()">
                <span class="material-icons">settings</span><span>Setting</span>
            </div>
        </div>
    </div> 

    <!-- Preview Bottom Sheet & Modals -->
    <div id="imageModal" class="image-modal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center;">
        <span class="close-modal" onclick="closeImageModal()" style="position:absolute; top:20px; right:20px; color:white; font-size:30px; cursor:pointer; z-index: 2001;">&times;</span>
        <div class="modal-content" style="max-width:90%; max-height:80%; position: relative;">
            <img id="modalImage" src="" style="max-width:100%; max-height:100%; border-radius:8px;">
        </div>
    </div>
    
    <div id="preview-window">
        <div class="preview-header">
            <div style="display: flex; align-items: center; gap: 10px; font-weight: bold;">
                <span class="material-icons-round" style="color: var(--primary-color);">receipt_long</span>
                Order Summary
            </div>
             <div style="display: flex; align-items: center; gap: 15px;">
                <label style="display: flex; align-items: center; gap: 6px; font-size: 0.9rem;">
                    <input type="checkbox" id="addOnCheckbox" onchange="updatePreview()" style="width: 16px; height: 16px;">
                    Add On
                </label>
                <span class="material-icons-round" onclick="togglePreview()" style="cursor: pointer; color: var(--text-secondary);">close</span>
            </div>
        </div>
        <div id="preview-content" style="font-size: 0.9rem; line-height: 1.6; max-height: 40vh; overflow-y: auto;"></div>
        <button class="whatsapp-button" onclick="copyAndSendWhatsApp()">
            <span class="material-icons-round" style="margin-right: 8px;">whatsapp</span>
            Send to WhatsApp
        </button>
    </div>

    <div id="side-dashboard" style="position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--surface-color); z-index: 1500; display: none; flex-direction: column; box-shadow: 2px 0 20px rgba(0,0,0,0.2);">
        <div style="padding: 40px 20px 20px; background: var(--primary-color); color: white;">
            <h2 style="margin-bottom: 5px;">Welcome</h2>
            <div id="dashboardUserName" style="font-size: 1.1rem;">Guest</div>
            <div id="dashboardUserRole" style="font-size: 0.8rem; opacity: 0.8;">User</div>
        </div>
        <div style="padding: 20px; display: flex; flex-direction: column; gap: 15px;">
             <button id="dashboardAdminButton" onclick="openAdminPanel(); toggleDashboard();" style="background: var(--bg-color); color: var(--text-primary); padding: 12px; justify-content: flex-start; border: 1px solid var(--border-color); border-radius: var(--radius-md); display: none;">
                <span class="material-icons" style="margin-right: 10px;">admin_panel_settings</span> Admin Panel
            </button>
            <button onclick="logout()" style="background: rgba(255, 68, 68, 0.1); color: var(--danger-color); padding: 12px; justify-content: flex-start; border: 1px solid var(--danger-color); border-radius: var(--radius-md);">
                <span class="material-icons" style="margin-right: 10px;">logout</span> Logout
            </button>
        </div>
    </div>
    <div id="dashboard-overlay" onclick="toggleDashboard()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1499; display: none;"></div>

    <!-- 3D ä¾èµ–åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <!-- åŸå§‹è„šæœ¬ -->
    <script src="script.js"></script>

    <script>
        let selectedStore = "";
        let isTransitioning = false; 

        window.startShopSelection = function(element, storeId) {
            if (isTransitioning) return; 
            isTransitioning = true; 

            const radio = document.querySelector(`input[value="${storeId}"]`);
            if(radio) radio.checked = true;
            selectedStore = storeId;
            document.getElementById('selectedShopDisplay').innerText = storeId.replace(/\*/g, '');

            // 1. éšè— UI
            document.querySelectorAll('.floating-shop-card').forEach(el => {
                el.style.opacity = '0';
                el.style.pointerEvents = 'none';
            });
            document.getElementById('three-ui').innerHTML = "<span style='color:#ffd700; font-size: 18px; font-weight:bold;'>CELEBRATING...</span>";

            // 2. å‘å°„åº—é“ºåå­—ä¸“ç”¨çƒŸèŠ± (ç™½è‰²ç²’å­)
            // æå–åº—é“ºçº¯å
            const cleanName = storeId.replace(/\*/g, '');
            launchShopNameFirework(cleanName);

            // 3. è¿‡æ¸¡åˆ°ä¸»é¡µé¢
            setTimeout(() => {
                const threeContainer = document.getElementById('three-container');
                const afterShopSelection = document.getElementById('after-shop-selection');
                const mainTitle = document.getElementById('mainTitle');
                
                threeContainer.classList.add('hide-3d');
                
                setTimeout(() => {
                    threeContainer.style.display = 'none';
                    afterShopSelection.style.display = 'block';
                    mainTitle.style.display = 'block';
                    document.getElementById('categoryTitle').style.display = 'block';
                    document.getElementById('categoryContainer').style.display = 'grid';
                    isTransitioning = false; 
                }, 800);
            }, 3000); // ç»´æŒ5ç§’è¿‡æ¸¡æœŸï¼Œä¸åŸé€»è¾‘ä¸€è‡´ï¼ŒçƒŸèŠ±åœ¨3.5ç§’å†…å®Œæˆ
        };

        window.resetToShopSelection = function() {
            const threeContainer = document.getElementById('three-container');
            const afterShopSelection = document.getElementById('after-shop-selection');
            const mainTitle = document.getElementById('mainTitle');

            afterShopSelection.style.display = 'none';
            mainTitle.style.display = 'none';
            
            threeContainer.style.display = 'block';
            void threeContainer.offsetWidth; 
            threeContainer.classList.remove('hide-3d');
            
            isExploded = false;
            isTransitioning = false;
            document.getElementById('three-ui').innerHTML = "Double Tap to Select Shop<br><span style='font-size:10px'>Happy New Year</span>";
            
            if(material) gsap.to(material.uniforms.uMix, { value: 0.0, duration: 2 });
            if(innerMaterial) gsap.to(innerMaterial.uniforms.uOpacity, { value: 0.0, duration: 1.5 });
            
            document.querySelectorAll('.floating-shop-card').forEach(el => {
                el.style.display = 'none';
                el.style.opacity = '0';
                el.style.pointerEvents = 'auto';
            });
        };

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                setTimeout(() => {
                    init3DWorld();
                    document.getElementById('three-container').style.display = 'block';
                }, 1000);
            }
        });

        // --- 3D æ ¸å¿ƒä»£ç  ---
        let scene, camera, renderer, controls, material;
        let innerMaterial; 
        let isExploded = false;
        let activeFireworks = [];
        let fireworkTexture;

        // --- ä¿®æ”¹ 1: æ›´æ–°é…ç½®ä¸ºä¸‰è¡Œ ---
        const CONFIG = {
            particleCount: 10000, 
            textLine1: "HAPPY",  
            textLine2: "NEW",    // ä¿®æ”¹è¿™é‡Œ
            textLine3: "YEAR",   // æ–°å¢è¿™é‡Œ
            font: "Bold 90px Arial", 
            innerText: "2026", 
            innerFont: "Bold 180px Arial", 
            color1: new THREE.Color(0xffd700),
            color2: new THREE.Color(0x00ffff),
            scatterRadius: 300,
            fireworkChance: 0.03
        };

        let shopElements = []; 

        function init3DWorld() {
            const container = document.getElementById('three-container');
            if(container.querySelector('canvas')) return; 

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.002);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 450; 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1.0;
            controls.enableZoom = false; 

            fireworkTexture = getFireworkTexture();

            initParticles();       
            initInnerParticles();  
            initShopCards();
            animate();

            let lastTap = 0;
            container.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    toggleExplosion();
                    e.preventDefault();
                }
                lastTap = currentTime;
            });
            container.addEventListener('dblclick', toggleExplosion);

            window.addEventListener('resize', onWindowResize, false);
        }

        // --- æ–°å¢ï¼šä¸“é—¨ç”¨äºç”Ÿæˆç™½è‰²åå­—çƒŸèŠ±çš„å‡½æ•° ---
        function launchShopNameFirework(text) {
            // 1. ç”Ÿæˆç›®æ ‡æ–‡å­—çš„åæ ‡ç‚¹
            const textCoords = getSmartTextCoordinates(text);
            const rocketStart = new THREE.Vector3(0, -300, 0);
            const explosionCenter = new THREE.Vector3(0, 50, 0); // åœ¨å±å¹•ä¸­å¿ƒåä¸Šçˆ†ç‚¸

            // 2. åˆ›å»ºå‡ç©ºçš„ç™½è‰²ç²’å­ (Rocket)
            const rocketGeo = new THREE.BufferGeometry().setFromPoints([rocketStart]);
            const rocketMat = new THREE.PointsMaterial({
                size: 15,
                color: 0xffffff, // çº¯ç™½
                map: fireworkTexture,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            const rocket = new THREE.Points(rocketGeo, rocketMat);
            scene.add(rocket);

            // 3. å‡ç©ºåŠ¨ç”» (1ç§’)
            const rocketPos = { y: rocketStart.y };
            gsap.to(rocketPos, {
                y: explosionCenter.y,
                duration: 1.0,
                ease: "power2.out",
                onUpdate: () => {
                    rocket.geometry.attributes.position.setY(0, rocketPos.y);
                    rocket.geometry.attributes.position.needsUpdate = true;
                },
                onComplete: () => {
                    // 4. åˆ°è¾¾é¡¶éƒ¨ï¼Œç§»é™¤Rocketï¼Œç”Ÿæˆæ–‡å­—ç²’å­
                    scene.remove(rocket);
                    explodeIntoText(textCoords, explosionCenter);
                }
            });
        }

        // --- æ–°å¢ï¼šæ–‡å­—çˆ†ç‚¸é€»è¾‘ ---
        function explodeIntoText(coords, centerPos) {
            const count = coords.length;
            const positions = new Float32Array(count * 3);
            
            // åˆå§‹æ‰€æœ‰ç‚¹éƒ½åœ¨çˆ†ç‚¸ä¸­å¿ƒ
            for(let i=0; i<count; i++) {
                positions[i*3] = centerPos.x;
                positions[i*3+1] = centerPos.y;
                positions[i*3+2] = centerPos.z;
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const material = new THREE.PointsMaterial({
                size: 5, // ç²’å­å¤§å°
                color: 0xffffff, // çº¯ç™½
                map: fireworkTexture,
                transparent: true,
                opacity: 1.0,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            const textSystem = new THREE.Points(geometry, material);
            scene.add(textSystem);

            // 5. ç²’å­æ‰©æ•£æˆæ–‡å­—å½¢çŠ¶ (0.8ç§’)
            // æˆ‘ä»¬ä¸ç›´æ¥ç”¨GSAPæ•°ç»„tweenï¼Œè¿™å¤ªæ…¢ã€‚æˆ‘ä»¬ç”¨ä¸€ä¸ªå¯¹è±¡è®°å½•è¿›åº¦
            const anim = { progress: 0 };
            
            gsap.to(anim, {
                progress: 1,
                duration: 0.8,
                ease: "back.out(1.2)", // å¸¦ä¸€ç‚¹å¼¹æ€§çš„çˆ†ç‚¸æ„Ÿ
                onUpdate: () => {
                    const posAttr = textSystem.geometry.attributes.position;
                    const p = anim.progress;
                    for(let i=0; i<count; i++) {
                        const target = coords[i];
                        // ä»ä¸­å¿ƒæ’å€¼åˆ°ç›®æ ‡ç‚¹
                        const x = centerPos.x + (target.x * p);
                        const y = centerPos.y + (target.y * p);
                        const z = centerPos.z + (target.z * p);
                        posAttr.setXYZ(i, x, y, z);
                    }
                    posAttr.needsUpdate = true;
                },
                onComplete: () => {
                    // 6. åœç•™ä¸€å°ä¼šï¼Œç„¶åæ¶ˆå¤±
                    gsap.to(material, {
                        opacity: 0,
                        duration: 1.5, // æ…¢æ…¢æ¶ˆå¤±
                        delay: 0.5,    // åœç•™0.5ç§’
                        onComplete: () => {
                            scene.remove(textSystem);
                            geometry.dispose();
                            material.dispose();
                        }
                    });
                }
            });
        }

        // --- æ–°å¢ï¼šæ™ºèƒ½æ–‡å­—åæ ‡ç”Ÿæˆ (é€‚åº”ä¸åŒé•¿åº¦çš„åº—é“ºå) ---
        function getSmartTextCoordinates(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 1024;
            const height = 256;
            canvas.width = width;
            canvas.height = height;

            // æ ¹æ®å­—æ•°è°ƒæ•´å­—ä½“å¤§å°
            let fontSize = 100;
            if (text.length > 10) fontSize = 70; 
            if (text.length > 15) fontSize = 50;

            ctx.font = `Bold ${fontSize}px Arial`;
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, width / 2, height / 2);

            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const coords = [];
            const step = 2; // é‡‡æ ·å¯†åº¦ï¼Œè¶Šå°è¶Šå¯†

            for(let y = 0; y < height; y += step) {
                for(let x = 0; x < width; x += step) {
                    if(data[(y * width + x) * 4 + 3] > 128) {
                        coords.push({
                            x: (x - width / 2) * 1.5, // é€‚å½“æ”¾å¤§
                            y: (height / 2 - y) * 1.5,
                            z: (Math.random() - 0.5) * 5 // å¢åŠ ä¸€ç‚¹ç‚¹åšåº¦
                        });
                    }
                }
            }
            return coords;
        }

        // --- ä¿®æ”¹ 2: æ›´æ–°æ–‡å­—åæ ‡è·å–é€»è¾‘ä»¥æ”¯æŒ3è¡Œ ---
        function getTextCoordinates(textLines, fontSize) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 1200;
            const height = 500; 
            canvas.width = width; 
            canvas.height = height; 
            
            ctx.font = fontSize || CONFIG.font;
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            if (textLines.length === 1) {
                ctx.fillText(textLines[0], width / 2, height / 2);
            } else if (textLines.length === 2) {
                ctx.fillText(textLines[0], width / 2, height * 0.35);
                ctx.fillText(textLines[1], width / 2, height * 0.75);
            } else {
                // ä¸‰è¡Œæ–‡å­—æ’ç‰ˆ
                ctx.fillText(textLines[0], width / 2, height * 0.22);
                ctx.fillText(textLines[1], width / 2, height * 0.50);
                ctx.fillText(textLines[2], width / 2, height * 0.78);
            }
            
            const imageData = ctx.getImageData(0,0,width,height);
            const data = imageData.data;
            const coords = [];
            const step = 4; 

            for(let y=0; y<height; y+=step) {
                for(let x=0; x<width; x+=step) {
                    if(data[(y*width+x)*4+3] > 128) {
                        coords.push({
                            x: (x - width/2) * 1.0, 
                            y: (height/2 - y) * 1.0
                        });
                    }
                }
            }
            return coords;
        }

        function initParticles() {
            // --- ä¿®æ”¹ 3: ä¼ å…¥ä¸‰è¡Œæ–‡å­— ---
            const coords = getTextCoordinates([CONFIG.textLine1, CONFIG.textLine2, CONFIG.textLine3], CONFIG.font); 
            const totalPoints = CONFIG.particleCount;
            
            const positions = new Float32Array(totalPoints * 3);
            const targets = new Float32Array(totalPoints * 3);
            const randoms = new Float32Array(totalPoints * 3);
            const colors = new Float32Array(totalPoints * 3);
            const sizes = new Float32Array(totalPoints);
            const randomOffsets = new Float32Array(totalPoints);

            for (let i = 0; i < totalPoints; i++) {
                const coord = coords[i % coords.length];
                targets[i*3] = coord.x;
                targets[i*3+1] = coord.y;
                targets[i*3+2] = (Math.random() - 0.5) * 50; 

                const phi = Math.acos(-1 + (2 * i) / totalPoints);
                const theta = Math.sqrt(totalPoints * Math.PI) * phi;
                const r = CONFIG.scatterRadius * (0.8 + Math.random() * 0.4);
                
                randoms[i*3] = r * Math.cos(theta) * Math.sin(phi);
                randoms[i*3+1] = r * Math.sin(theta) * Math.sin(phi);
                randoms[i*3+2] = r * Math.cos(phi);

                positions[i*3] = targets[i*3];
                positions[i*3+1] = targets[i*3+1];
                positions[i*3+2] = targets[i*3+2];

                const mixedColor = new THREE.Color().lerpColors(CONFIG.color1, CONFIG.color2, Math.random());
                colors[i*3] = mixedColor.r;
                colors[i*3+1] = mixedColor.g;
                colors[i*3+2] = mixedColor.b;
                sizes[i] = Math.random();
                randomOffsets[i] = Math.random() * Math.PI;
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('targetPos', new THREE.BufferAttribute(targets, 3));
            geometry.setAttribute('randomPos', new THREE.BufferAttribute(randoms, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            geometry.setAttribute('aOffset', new THREE.BufferAttribute(randomOffsets, 1));

            material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uPixelRatio: { value: renderer.getPixelRatio() },
                    uMix: { value: 0.0 }
                },
                vertexShader: `
                    uniform float uTime;
                    uniform float uPixelRatio;
                    uniform float uMix;
                    attribute vec3 targetPos;
                    attribute vec3 randomPos;
                    attribute vec3 color;
                    attribute float size;
                    attribute float aOffset;
                    varying vec3 vColor;
                    void main() {
                        vColor = color;
                        vec3 pos = mix(targetPos, randomPos, uMix);
                        float wave = sin(uTime * 0.5 + aOffset) * (0.5 + uMix * 5.0);
                        pos += normalize(pos) * wave;
                        vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                        gl_Position = projectionMatrix * mvPosition;
                        gl_PointSize = (4.0 * size * uPixelRatio) * (300.0 / -mvPosition.z);
                    }
                `,
                fragmentShader: `
                    varying vec3 vColor;
                    void main() {
                        float r = distance(gl_PointCoord, vec2(0.5));
                        if (r > 0.5) discard;
                        gl_FragColor = vec4(vColor, 0.8);
                    }
                `,
                transparent: true,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });

            const particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        function initInnerParticles() {
            const coords = getTextCoordinates([CONFIG.innerText], CONFIG.innerFont); 
            const totalPoints = Math.floor(CONFIG.particleCount * 0.5); 
            
            const positions = new Float32Array(totalPoints * 3);
            const colors = new Float32Array(totalPoints * 3);
            const sizes = new Float32Array(totalPoints);
            const randomOffsets = new Float32Array(totalPoints);

            const gold = new THREE.Color(0xffd700);
            const white = new THREE.Color(0xffffff);

            for (let i = 0; i < totalPoints; i++) {
                const coord = coords[i % coords.length];
                
                const scale = 0.5; 
                positions[i*3] = coord.x * scale;
                positions[i*3+1] = coord.y * scale;
                positions[i*3+2] = (Math.random() - 0.5) * 20;

                const mixedColor = new THREE.Color().lerpColors(gold, white, Math.random() * 0.5);
                colors[i*3] = mixedColor.r;
                colors[i*3+1] = mixedColor.g;
                colors[i*3+2] = mixedColor.b;
                sizes[i] = Math.random();
                randomOffsets[i] = Math.random() * Math.PI;
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            geometry.setAttribute('aOffset', new THREE.BufferAttribute(randomOffsets, 1));

            innerMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uPixelRatio: { value: renderer.getPixelRatio() },
                    uOpacity: { value: 0.0 }
                },
                vertexShader: `
                    uniform float uTime;
                    uniform float uPixelRatio;
                    attribute vec3 color;
                    attribute float size;
                    attribute float aOffset;
                    varying vec3 vColor;
                    void main() {
                        vColor = color;
                        vec3 pos = position;
                        pos.y += sin(uTime + aOffset) * 1.5;
                        vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                        gl_Position = projectionMatrix * mvPosition;
                        gl_PointSize = (3.0 * size * uPixelRatio) * (300.0 / -mvPosition.z);
                    }
                `,
                fragmentShader: `
                    uniform float uOpacity;
                    varying vec3 vColor;
                    void main() {
                        if (uOpacity <= 0.01) discard;
                        float r = distance(gl_PointCoord, vec2(0.5));
                        if (r > 0.5) discard;
                        gl_FragColor = vec4(vColor, uOpacity); 
                    }
                `,
                transparent: true,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });

            const particles = new THREE.Points(geometry, innerMaterial);
            scene.add(particles);
        }

        function getFireworkTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(0.4, 'rgba(255,255,255,0.4)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, 32, 32);
            return new THREE.Texture(canvas);
        }

        const gravityVector = new THREE.Vector3(0, -0.08, 0);

        class Firework {
            constructor(scene) {
                this.scene = scene;
                this.isDead = false;
                this.exploded = false;
                const startX = (Math.random() - 0.5) * 600;
                const startZ = (Math.random() - 0.5) * 300;
                this.position = new THREE.Vector3(startX, -200, startZ);
                this.targetY = -50 + Math.random() * 200; 
                this.velocity = new THREE.Vector3(0, 3 + Math.random() * 2, 0);
                this.color = new THREE.Color();
                this.color.setHSL(Math.random(), 1, 0.6);

                const rocketGeo = new THREE.BufferGeometry();
                rocketGeo.setAttribute('position', new THREE.Float32BufferAttribute(this.position.toArray(), 3));
                const rocketMat = new THREE.PointsMaterial({
                    size:   15,
                    color: this.color,
                    map: fireworkTexture,
                    transparent: true,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    opacity: 1
                });
                this.rocket = new THREE.Points(rocketGeo, rocketMat);
                fireworkTexture.needsUpdate = true; 
                this.scene.add(this.rocket);
                this.sparks = []; 
                this.sparkSystem = null; 
            }
            update() {
                if (this.isDead) return;
                if (!this.exploded) {
                    this.position.add(this.velocity);
                    this.rocket.geometry.attributes.position.setXYZ(0, this.position.x, this.position.y, this.position.z);
                    this.rocket.geometry.attributes.position.needsUpdate = true;
                    if (this.position.y >= this.targetY || this.velocity.y < 0) this.explode();
                } else {
                    if (!this.sparkSystem) return;
                    const positions = this.sparkSystem.geometry.attributes.position.array;
                    for (let i = 0; i < this.sparks.length; i++) {
                        const spark = this.sparks[i];
                        spark.velocity.add(gravityVector); 
                        spark.velocity.multiplyScalar(0.96); 
                        spark.position.add(spark.velocity);
                        positions[i * 3] = spark.position.x;
                        positions[i * 3 + 1] = spark.position.y;
                        positions[i * 3 + 2] = spark.position.z;
                        spark.life -= 0.015;
                    }
                    this.sparkSystem.geometry.attributes.position.needsUpdate = true;
                    this.sparkSystem.material.opacity -= 0.015;
                    if (this.sparkSystem.material.opacity <= 0) this.cleanup();
                }
            }
            explode() {
                this.exploded = true;
                this.scene.remove(this.rocket);
                const sparkCount = 40 + Math.floor(Math.random() * 40);
                const positions = [];
                for (let i = 0; i < sparkCount; i++) {
                    const u = Math.random();
                    const v = Math.random();
                    const theta = 2 * Math.PI * u;
                    const phi = Math.acos(2 * v - 1);
                    const speed = 1.0 + Math.random() * 2.0;
                    const vx = speed * Math.sin(phi) * Math.cos(theta);
                    const vy = speed * Math.sin(phi) * Math.sin(theta);
                    const vz = speed * Math.cos(phi);
                    this.sparks.push({
                        position: this.position.clone(),
                        velocity: new THREE.Vector3(vx, vy, vz),
                        life: 1.0
                    });
                    positions.push(this.position.x, this.position.y, this.position.z);
                }
                const sparkGeo = new THREE.BufferGeometry();
                sparkGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                const sparkMat = new THREE.PointsMaterial({
                    size: 4,
                    color: this.color,
                    map: fireworkTexture,
                    transparent: true,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    opacity: 1.0
                });
                this.sparkSystem = new THREE.Points(sparkGeo, sparkMat);
                this.scene.add(this.sparkSystem);
            }
            cleanup() {
                this.isDead = true;
                if (this.rocket) {
                    this.scene.remove(this.rocket);
                    this.rocket.geometry.dispose();
                    this.rocket.material.dispose();
                }
                if (this.sparkSystem) {
                    this.scene.remove(this.sparkSystem);
                    this.sparkSystem.geometry.dispose();
                    this.sparkSystem.material.dispose();
                }
            }
        }

        function initShopCards() {
            const layer = document.getElementById('floating-shops-layer');
            const originalData = document.querySelectorAll('.shop-data');
            const phi = Math.PI * (3 - Math.sqrt(5)); 
            const count = originalData.length;
            const radius = 280; 

            originalData.forEach((data, i) => {
                const card = document.createElement('div');
                card.className = 'floating-shop-card';
                card.innerHTML = `
                    <img src="${data.dataset.img}" onerror="this.src='https://placehold.co/140x100?text=Shop'">
                    <div class="shop-name">${data.dataset.name}</div>
                `;
                card.onclick = () => startShopSelection(card, data.dataset.id);
                layer.appendChild(card);
                const y = 1 - (i / (count - 1)) * 2; 
                const r = Math.sqrt(1 - y * y); 
                const theta = phi * i; 
                const x = Math.cos(theta) * r;
                const z = Math.sin(theta) * r;
                const posVector = new THREE.Vector3(x * radius, y * radius * 0.8, z * radius);
                shopElements.push({ dom: card, pos: posVector });
            });
        }

        function toggleExplosion() {
            if (isTransitioning) return;

            isExploded = !isExploded;
            
            gsap.to(material.uniforms.uMix, {
                value: isExploded ? 1.0 : 0.0,
                duration: 2.5,
                ease: "power2.inOut"
            });

            if (innerMaterial) {
                gsap.to(innerMaterial.uniforms.uOpacity, {
                    value: isExploded ? 1.0 : 0.0, 
                    duration: isExploded ? 3.0 : 1.5,
                    ease: "power2.inOut"
                });
            }

            gsap.to(controls, {
                autoRotateSpeed: isExploded ? 0.2 : 1.0,
                duration: 1
            });

            const cards = document.querySelectorAll('.floating-shop-card');
            
            if(isExploded) {
                // ä¿®æ”¹ç‚¹ï¼šå»¶è¿Ÿ2.2ç§’åï¼Œå¡ç‰‡æ‰é€ä¸ªå‡ºç°
                setTimeout(() => {
                    cards.forEach((card, i) => {
                        card.style.display = 'block';
                        // ä½¿ç”¨CSS transitioné…åˆå»¶æ—¶
                        setTimeout(() => {
                            card.style.opacity = 1;
                        }, i * 150); // é€ä¸ªå‡ºç°
                    });
                }, 2200);
            } else {
                cards.forEach((card) => {
                    card.style.opacity = 0;
                    setTimeout(() => card.style.display = 'none', 500);
                });
            }
            
            document.querySelector('#three-ui').innerHTML = isExploded 
                ? "Click a Card to Select<br><span style='font-size:10px'>Double tap to Back</span>" 
                : "Double Tap to Select Shop<br><span style='font-size:10px'>Happy New Year</span>";
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            material.uniforms.uPixelRatio.value = renderer.getPixelRatio();
            if(innerMaterial) innerMaterial.uniforms.uPixelRatio.value = renderer.getPixelRatio();
        }

        function animate() {
            requestAnimationFrame(animate);
            if(document.getElementById('three-container').style.display === 'none') return;
            const time = performance.now() * 0.001;
            
            if(material) material.uniforms.uTime.value = time;
            if(innerMaterial) innerMaterial.uniforms.uTime.value = time;

            let chance = CONFIG.fireworkChance;
            if (isTransitioning) chance = 0.4;

            if (Math.random() < chance) activeFireworks.push(new Firework(scene));
            
            for (let i = activeFireworks.length - 1; i >= 0; i--) {
                const fw = activeFireworks[i];
                fw.update();
                if (fw.isDead) activeFireworks.splice(i, 1);
            }

            controls.update();
            renderer.render(scene, camera);

            if(isExploded && !isTransitioning) updateShopCardPositions();
        }

        function updateShopCardPositions() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const widthHalf = width / 2;
            const heightHalf = height / 2;
            shopElements.forEach(item => {
                const pos = item.pos.clone();
                pos.project(camera);
                if (pos.z < 1) {
                    const x = (pos.x * widthHalf) + widthHalf;
                    const y = -(pos.y * heightHalf) + heightHalf;
                    const scale = Math.max(0.5, 1 - pos.z); 
                    item.dom.style.transform = `translate(-50%, -50%) translate3d(${x}px, ${y}px, 0) scale(${scale})`;
                    item.dom.style.zIndex = Math.floor((1 - pos.z) * 100); 
                    // è¿™é‡Œä¸åš display æ§åˆ¶ï¼Œäº¤ç»™ toggleExplosion çš„é€»è¾‘
                    // ä»…æ›´æ–°ä½ç½®
                }
            });
        }
    </script>
</body>
</html>